---
import Layout from '@/layouts/Layout.astro'
import Header from '@/sections/Header.astro'
import { supabaseAdmin } from '@/supabase-admin'
import { isAdmin } from '@/utils/admin'

// Verificar que el usuario est√© autenticado
if (!Astro.locals.user) {
  return Astro.redirect('/404')
}

// Verificar que el email del usuario est√© en la lista de admins
const userId = Astro.locals.user.id
if (!isAdmin(userId)) {
  return Astro.redirect('/404')
}

// Obtener estad√≠sticas generales en paralelo
const [
  { count: totalCouponsUsed },
  { data: uniqueUsersCount },
  { data: averageCouponsPerUser },
  { data: userCoupons },
] = await Promise.all([
  // 1. Total de cupones usados
  supabaseAdmin.from('coupons').select('*', { count: 'exact', head: true }).eq('is_used', true),

  // 2. Total de usuarios con cupones
  supabaseAdmin.rpc('total_unique_users_with_coupons'),

  // 3. Calcular media de cupones por usuario
  supabaseAdmin.rpc('avg_coupons_per_user'),

  // 4. Obtener cupones del usuario actual para el header
  supabaseAdmin
    .from('coupons')
    .select('used_at')
    .eq('used_by', Astro.locals.user.id)
    .eq('is_used', true),
])

const totalUserCoupons = userCoupons?.length || 0
---

<Layout title="Panel de Administraci√≥n - Big Ibai 2025">
  <div class="flex min-h-screen flex-col">
    <Header participationCount={totalUserCoupons} />

    <main class="mx-auto w-full max-w-7xl flex-1 px-4 py-12 md:py-20">
      <div class="space-y-8">
        <!-- Encabezado -->
        <div class="text-center">
          <h1 class="text-shadow-title text-4xl font-bold text-white md:text-5xl lg:text-6xl">
            Panel de Administraci√≥n
          </h1>
          <p class="mt-4 text-lg text-white/80 md:text-xl">
            Bienvenido, {Astro.locals.user.user_metadata.full_name}
          </p>
        </div>

        <!-- Estad√≠sticas generales -->
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
          <!-- Total de usuarios -->
          <div class="bento-card group overflow-hidden" style="animation-delay: 0.1s;">
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <div class="mb-4 text-6xl">üë•</div>
              <h3 class="text-shadow-title text-2xl font-bold text-white md:text-3xl">
                {uniqueUsersCount}
              </h3>
              <p class="mt-2 text-white/80">Usuarios con cupones</p>
            </div>
          </div>

          <!-- Cupones usados -->
          <div class="bento-card group overflow-hidden" style="animation-delay: 0.2s;">
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <div class="mb-4 text-6xl">üéüÔ∏è</div>
              <h3 class="text-shadow-title text-2xl font-bold text-white md:text-3xl">
                {totalCouponsUsed || 0}
              </h3>
              <p class="mt-2 text-white/80">Cupones usados</p>
            </div>
          </div>

          <!-- Media de cupones por usuario -->
          <div class="bento-card group overflow-hidden" style="animation-delay: 0.3s;">
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <div class="mb-4 text-6xl">üìä</div>
              <h3 class="text-shadow-title text-2xl font-bold text-white md:text-3xl">
                {averageCouponsPerUser.toFixed(2)}
              </h3>
              <p class="mt-2 text-white/80">Media cupones/usuario</p>
            </div>
          </div>
        </div>

        <!-- Grid de b√∫squedas -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
          <!-- Secci√≥n de validaci√≥n de cupones -->
          <div class="bento-card overflow-hidden" style="animation-delay: 0.4s;">
            <div class="p-8">
              <h2 class="text-shadow-title mb-6 text-center text-3xl font-bold text-white">
                Validar Cup√≥n
              </h2>
              <p class="mb-6 text-center text-white/80">
                Introduce el c√≥digo de un cup√≥n para verificar si ha sido usado
              </p>

              <form id="coupon-validation-form" class="mx-auto max-w-md space-y-4">
                <div>
                  <input
                    type="text"
                    id="coupon-input"
                    name="coupon"
                    placeholder="C√≥digo del cup√≥n"
                    class="w-full rounded-lg border border-white/20 bg-black/30 px-4 py-3 text-white placeholder-white/50 backdrop-blur-sm focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/50"
                    required
                  />
                </div>

                <button
                  type="submit"
                  class="w-full rounded-lg bg-brand px-6 py-3 font-bold text-black transition-all hover:scale-105 hover:brightness-110 active:scale-95"
                >
                  Validar Cup√≥n
                </button>
              </form>

              <!-- Resultado de la b√∫squeda -->
              <div id="coupon-result" class="mt-6">
                <!-- Loading -->
                <div
                  id="coupon-loading"
                  class="hidden rounded-lg bg-white/5 p-6 text-center backdrop-blur-sm"
                >
                  <div class="mb-4 text-4xl">‚è≥</div>
                  <p class="text-white/80">Buscando cup√≥n...</p>
                </div>

                <!-- Error -->
                <div
                  id="coupon-error"
                  class="hidden rounded-lg bg-red-500/20 p-6 backdrop-blur-sm border border-red-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚ùå</div>
                  <p id="coupon-error-message" class="text-center text-white font-bold"></p>
                </div>

                <!-- Cup√≥n no usado -->
                <div
                  id="coupon-unused"
                  class="hidden rounded-lg bg-yellow-500/20 p-6 backdrop-blur-sm border border-yellow-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚ö†Ô∏è</div>
                  <h3 class="mb-2 text-center text-xl font-bold text-white">Cup√≥n no usado</h3>
                  <p class="text-center text-white/80">
                    Este cup√≥n existe pero a√∫n no ha sido utilizado
                  </p>
                  <div class="mt-4 text-center">
                    <p class="text-sm text-white/60">ID: <span id="coupon-unused-id"></span></p>
                  </div>
                </div>

                <!-- Cup√≥n usado -->
                <div
                  id="coupon-used"
                  class="hidden rounded-lg bg-green-500/20 p-6 backdrop-blur-sm border border-green-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚úÖ</div>
                  <h3 class="mb-4 text-center text-xl font-bold text-white">Cup√≥n usado</h3>

                  <div class="space-y-3 text-white/90">
                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">ID del cup√≥n:</span>
                      <span id="coupon-used-id" class="font-mono text-sm"></span>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Usuario ID:</span>
                      <span id="coupon-used-by" class="font-mono text-sm"></span>
                    </div>

                    <div id="coupon-used-email-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Email:</span>
                        <span id="coupon-used-email" class="text-sm"></span>
                      </div>
                    </div>

                    <div id="coupon-used-name-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Nombre:</span>
                        <span id="coupon-used-name" class="text-sm"></span>
                      </div>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Usado el:</span>
                      <span id="coupon-used-date" class="text-sm"></span>
                    </div>

                    <div id="coupon-used-ip-row" class="hidden">
                      <div class="flex justify-between pb-2">
                        <span class="font-semibold">IP:</span>
                        <span id="coupon-used-ip" class="font-mono text-sm"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Secci√≥n de b√∫squeda de usuario -->
          <div class="bento-card overflow-hidden" style="animation-delay: 0.5s;">
            <div class="p-8">
              <h2 class="text-shadow-title mb-6 text-center text-3xl font-bold text-white">
                Buscar Usuario
              </h2>
              <p class="mb-6 text-center text-white/80">
                Introduce el email o ID de un usuario para ver su informaci√≥n
              </p>

              <form id="user-search-form" class="mx-auto max-w-md space-y-4">
                <div>
                  <input
                    type="text"
                    id="user-query-input"
                    name="query"
                    placeholder="Email o ID del usuario"
                    class="w-full rounded-lg border border-white/20 bg-black/30 px-4 py-3 text-white placeholder-white/50 backdrop-blur-sm focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/50"
                    required
                  />
                </div>

                <button
                  type="submit"
                  class="w-full rounded-lg bg-brand px-6 py-3 font-bold text-black transition-all hover:scale-105 hover:brightness-110 active:scale-95"
                >
                  Buscar Usuario
                </button>
              </form>

              <!-- Resultado de la b√∫squeda -->
              <div id="user-result" class="mt-6">
                <!-- Loading -->
                <div
                  id="user-loading"
                  class="hidden rounded-lg bg-white/5 p-6 text-center backdrop-blur-sm"
                >
                  <div class="mb-4 text-4xl">‚è≥</div>
                  <p class="text-white/80">Buscando usuario...</p>
                </div>

                <!-- Error -->
                <div
                  id="user-error"
                  class="hidden rounded-lg bg-red-500/20 p-6 backdrop-blur-sm border border-red-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚ùå</div>
                  <p id="user-error-message" class="text-center text-white font-bold"></p>
                </div>

                <!-- Usuario encontrado -->
                <div
                  id="user-found"
                  class="hidden rounded-lg bg-blue-500/20 p-6 backdrop-blur-sm border border-blue-500/30"
                >
                  <div class="mb-4 text-center text-4xl">üë§</div>
                  <h3 class="mb-4 text-center text-xl font-bold text-white">Usuario encontrado</h3>

                  <div class="space-y-3 text-white/90">
                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">ID:</span>
                      <span id="user-id" class="font-mono text-sm"></span>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Email:</span>
                      <span id="user-email" class="text-sm"></span>
                    </div>

                    <div id="user-name-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Nombre:</span>
                        <span id="user-name" class="text-sm"></span>
                      </div>
                    </div>

                    <div id="user-provider-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Proveedor:</span>
                        <span id="user-provider" class="text-sm"></span>
                      </div>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Creado:</span>
                      <span id="user-created" class="text-sm"></span>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">√öltimo acceso:</span>
                      <span id="user-last-signin" class="text-sm"></span>
                    </div>

                    <div class="flex justify-between pb-2">
                      <span class="font-semibold">Email verificado:</span>
                      <span id="user-email-verified" class="text-sm"></span>
                    </div>
                  </div>

                  <!-- Cupones del usuario -->
                  <div id="user-coupons-section" class="mt-4 border-t border-white/20 pt-4">
                    <h4 class="mb-3 text-center font-semibold text-white">
                      Cupones usados (<span id="user-coupons-count">0</span>)
                    </h4>
                    <div id="user-coupons-list" class="max-h-60 space-y-2 overflow-y-auto">
                      <!-- Los cupones se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    <div id="user-no-coupons" class="hidden text-center">
                      <p class="text-white/60">No ha usado ning√∫n cup√≥n</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</Layout>

<script>
  const $ = document.querySelector.bind(document)
  const form = $('#coupon-validation-form') as HTMLFormElement
  const couponInput = $('#coupon-input') as HTMLInputElement

  // Elementos para cup√≥n
  const couponLoading = $('#coupon-loading') as HTMLDivElement
  const couponError = $('#coupon-error') as HTMLDivElement
  const couponErrorMessage = $('#coupon-error-message') as HTMLParagraphElement
  const couponUnused = $('#coupon-unused') as HTMLDivElement
  const couponUnusedId = $('#coupon-unused-id') as HTMLSpanElement
  const couponUsed = $('#coupon-used') as HTMLDivElement
  const couponUsedId = $('#coupon-used-id') as HTMLSpanElement
  const couponUsedBy = $('#coupon-used-by') as HTMLSpanElement
  const couponUsedEmailRow = $('#coupon-used-email-row') as HTMLDivElement
  const couponUsedEmail = $('#coupon-used-email') as HTMLSpanElement
  const couponUsedNameRow = $('#coupon-used-name-row') as HTMLDivElement
  const couponUsedName = $('#coupon-used-name') as HTMLSpanElement
  const couponUsedDate = $('#coupon-used-date') as HTMLSpanElement
  const couponUsedIpRow = $('#coupon-used-ip-row') as HTMLDivElement
  const couponUsedIp = $('#coupon-used-ip') as HTMLSpanElement

  // Funci√≥n para ocultar todos los estados de cup√≥n
  function hideAllCouponStates() {
    couponLoading.classList.add('hidden')
    couponError.classList.add('hidden')
    couponUnused.classList.add('hidden')
    couponUsed.classList.add('hidden')
    couponUsedIpRow.classList.add('hidden')
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const coupon = couponInput.value.trim()
    if (!coupon) return

    // Mostrar loading
    hideAllCouponStates()
    couponLoading.classList.remove('hidden')

    try {
      const response = await fetch(
        `/api/admin/validate-coupon?coupon=${encodeURIComponent(coupon)}`
      )
      const data = await response.json()

      hideAllCouponStates()

      if (!response.ok) {
        // Mostrar error
        couponErrorMessage.textContent = data.error || 'Error al buscar el cup√≥n'
        couponError.classList.remove('hidden')
        return
      }

      if (!data.is_used) {
        // Mostrar cup√≥n no usado
        couponUnusedId.textContent = String(data.id || '')
        couponUnused.classList.remove('hidden')
      } else {
        // Mostrar cup√≥n usado
        const usedDate = new Date(data.used_at)
        const formattedDate = usedDate.toLocaleString('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        })

        couponUsedId.textContent = String(data.id || '')
        couponUsedBy.textContent = String(data.used_by || '')
        couponUsedDate.textContent = formattedDate

        // Mostrar u ocultar campos opcionales
        if (data.user_email) {
          couponUsedEmail.textContent = String(data.user_email)
          couponUsedEmailRow.classList.remove('hidden')
        } else {
          couponUsedEmailRow.classList.add('hidden')
        }

        if (data.user_name) {
          couponUsedName.textContent = String(data.user_name)
          couponUsedNameRow.classList.remove('hidden')
        } else {
          couponUsedNameRow.classList.add('hidden')
        }

        if (data.used_ip) couponUsedIp.textContent = String(data.used_ip)
        couponUsedIpRow.classList.toggle('hidden', !data.used_ip)

        couponUsed.classList.remove('hidden')
      }
    } catch (error) {
      console.error('Error:', error)
      hideAllCouponStates()
      couponErrorMessage.textContent = 'Error al validar el cup√≥n. Int√©ntalo de nuevo m√°s tarde.'
      couponError.classList.remove('hidden')
    }
  })

  // Script para b√∫squeda de usuario
  const userForm = $('#user-search-form') as HTMLFormElement
  const queryInput = $('#user-query-input') as HTMLInputElement

  // Elementos para usuario
  const userLoading = $('#user-loading') as HTMLDivElement
  const userError = $('#user-error') as HTMLDivElement
  const userErrorMessage = $('#user-error-message') as HTMLParagraphElement
  const userFound = $('#user-found') as HTMLDivElement
  const userId = $('#user-id') as HTMLSpanElement
  const userEmail = $('#user-email') as HTMLSpanElement
  const userNameRow = $('#user-name-row') as HTMLDivElement
  const userName = $('#user-name') as HTMLSpanElement
  const userProviderRow = $('#user-provider-row') as HTMLDivElement
  const userProvider = $('#user-provider') as HTMLSpanElement
  const userCreated = $('#user-created') as HTMLSpanElement
  const userLastSignin = $('#user-last-signin') as HTMLSpanElement
  const userEmailVerified = $('#user-email-verified') as HTMLSpanElement
  const userCouponsCount = $('#user-coupons-count') as HTMLSpanElement
  const userCouponsList = $('#user-coupons-list') as HTMLDivElement
  const userNoCoupons = $('#user-no-coupons') as HTMLDivElement

  // Funci√≥n para ocultar todos los estados de usuario
  function hideAllUserStates() {
    userLoading.classList.add('hidden')
    userError.classList.add('hidden')
    userFound.classList.add('hidden')
  }

  userForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const query = queryInput.value.trim()
    if (!query) return

    // Mostrar loading
    hideAllUserStates()
    userLoading.classList.remove('hidden')

    try {
      const response = await fetch(`/api/admin/search-user?query=${encodeURIComponent(query)}`)
      const data = await response.json()

      hideAllUserStates()

      if (!response.ok) {
        // Mostrar error
        userErrorMessage.textContent = data.error || 'Error al buscar el usuario'
        userError.classList.remove('hidden')
        return
      }

      // Formatear fechas
      const createdDate = new Date(data.created_at)
      const formattedCreatedDate = createdDate.toLocaleString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      })

      const lastSignIn = data.last_sign_in_at
        ? new Date(data.last_sign_in_at).toLocaleString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })
        : 'Nunca'

      // Actualizar datos del usuario
      userId.textContent = String(data.id || '')
      userEmail.textContent = String(data.email || '')
      userCreated.textContent = formattedCreatedDate
      userLastSignin.textContent = lastSignIn
      userEmailVerified.textContent = data.email_confirmed_at ? '‚úÖ S√≠' : '‚ùå No'

      // Mostrar u ocultar campos opcionales
      if (data.name) userName.textContent = String(data.name)
      userNameRow.classList.toggle('hidden', !data.name)

      if (data.provider) userProvider.textContent = String(data.provider)
      userProviderRow.classList.toggle('hidden', !data.provider)

      // Manejar cupones
      userCouponsList.innerHTML = '' // Limpiar lista anterior

      if (data.coupons && data.coupons.length > 0) {
        userCouponsCount.textContent = String(data.coupons.length)
        userNoCoupons.classList.add('hidden')

        // Crear elementos de cupones de forma segura
        data.coupons.forEach((coupon: any) => {
          const usedDate = new Date(coupon.used_at).toLocaleString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })

          const couponDiv = document.createElement('div')
          couponDiv.className = 'rounded bg-white/5 p-3'

          const couponContent = document.createElement('div')
          couponContent.className = 'flex justify-between text-xs text-white/70'

          const couponId = document.createElement('span')
          couponId.textContent = `ID: ${coupon.id || ''}`

          const couponDate = document.createElement('span')
          couponDate.textContent = usedDate

          couponContent.appendChild(couponId)
          couponContent.appendChild(couponDate)
          couponDiv.appendChild(couponContent)
          userCouponsList.appendChild(couponDiv)
        })
      } else {
        userCouponsCount.textContent = '0'
        userNoCoupons.classList.remove('hidden')
      }

      userFound.classList.remove('hidden')
    } catch (error) {
      console.error('Error:', error)
      hideAllUserStates()
      userErrorMessage.textContent = 'Error al buscar el usuario. Int√©ntalo de nuevo m√°s tarde.'
      userError.classList.remove('hidden')
    }
  })
</script>

<style>
  .bento-card {
    position: relative;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.5) 0%, rgba(0, 41, 107, 0.7) 100%);
    border-radius: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    animation: fadeInScale 0.6s ease-out;
    animation-fill-mode: both;
    transition: all 0.3s ease;
  }

  .bento-card:hover {
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 20px 60px rgba(139, 92, 246, 0.3);
    transform: translateY(-4px);
  }

  .bento-card::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 1.5rem;
    padding: 1px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
    mask-composite: exclude;
    pointer-events: none;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
</style>
